name: Build Android APK

on:
  push:
    branches:
      - main
      - master
      - release
  pull_request:
    branches:
      - main
      - master
      - release
  workflow_dispatch:

jobs:
  build-android:
    name: Build Unsigned APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Generate Android project
        run: npx expo prebuild --platform android --clean

      - name: Get app info from app.json
        id: app-info
        run: |
          SLUG=$(node -p "require('./app.json').expo.slug" | tr -d '"')
          APP_NAME=$(node -p "require('./app.json').expo.name" | tr -d '"')
          PACKAGE_NAME=$(node -p "require('./app.json').expo.android.package || require('./app.json').expo.slug" | tr -d '"')
          echo "app_slug=$SLUG" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

      - name: Verify Android project structure
        id: verify-project
        working-directory: android
        run: |
          echo "Listing Android directory contents:"
          ls -la
          echo ""
          
          if [ -d "app" ]; then
            echo "Found app directory"
            echo "project_structure=valid" >> $GITHUB_OUTPUT
          else
            echo "Error: app directory not found!"
            echo "Available files:"
            ls -la
            exit 1
          fi
          
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "Found build.gradle file"
          else
            echo "Warning: build.gradle not found in root"
          fi
          
          echo "Project structure verified"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build Android APK (unsigned)
        working-directory: android
        run: |
          ./gradlew assembleRelease --no-daemon --stacktrace
          
          # Check if build succeeded
          if [ $? -ne 0 ]; then
            echo "Build failed!"
            exit 1
          fi
          
          echo "Build completed successfully"

      - name: Find APK file
        id: find-apk
        working-directory: android
        run: |
          # Look for APK in common locations
          APK_PATHS=(
            "app/build/outputs/apk/release/app-release.apk"
            "app/build/outputs/apk/release/app-release-unsigned.apk"
            "app/build/outputs/apk/release/*.apk"
          )
          
          APK_FILE=""
          for path in "${APK_PATHS[@]}"; do
            if ls $path 1> /dev/null 2>&1; then
              APK_FILE=$(ls $path | head -n 1)
              echo "Found APK: $APK_FILE"
              break
            fi
          done
          
          # If still not found, search recursively
          if [ -z "$APK_FILE" ]; then
            echo "APK not found in expected locations, searching recursively..."
            APK_FILE=$(find app/build/outputs -name "*.apk" -type f | grep -i release | head -n 1)
            if [ -n "$APK_FILE" ]; then
              echo "Found APK: $APK_FILE"
            fi
          fi
          
          if [ -z "$APK_FILE" ]; then
            echo "Error: APK file not found!"
            echo "Searched in:"
            for path in "${APK_PATHS[@]}"; do
              echo "  - $path"
            done
            echo ""
            echo "Listing app/build/outputs structure:"
            find app/build/outputs -type f 2>/dev/null | head -n 20 || true
            exit 1
          fi
          
          APK_NAME=$(basename "$APK_FILE")
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "APK found: $APK_NAME"
          ls -lh "$APK_FILE"

      - name: Prepare APK artifact
        id: prepare-apk
        run: |
          mkdir -p build
          cp "android/${{ steps.find-apk.outputs.apk_path }}" "build/${{ steps.find-apk.outputs.apk_name }}"
          echo "APK copied to build directory"
          ls -lh "build/${{ steps.find-apk.outputs.apk_name }}"
          echo "apk_name=${{ steps.find-apk.outputs.apk_name }}" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build-APK
          path: build/${{ steps.prepare-apk.outputs.apk_name }}
          retention-days: 30

